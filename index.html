<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Actions 実行時間トレンド解析</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; background-color: #f6f8fa; color: #24292f; }
        h1 { border-bottom: 1px solid #d0d7de; padding-bottom: 10px; }
        .container { background: white; padding: 20px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.12); border: 1px solid #d0d7de; }
        .input-area { margin-bottom: 20px; }
        textarea { width: 100%; height: 100px; margin-top: 10px; padding: 8px; border-radius: 6px; border: 1px solid #d0d7de; font-family: monospace; font-size: 12px; }
        input[type="file"] { margin-top: 10px; }
        button { margin-top: 10px; background-color: #2da44e; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-weight: bold; cursor: pointer; }
        button:hover { background-color: #2c974b; }
        #stats { margin-top: 20px; display: flex; gap: 20px; font-size: 0.9em; color: #57606a; }
        .stat-box { background: #f6f8fa; padding: 10px; border-radius: 6px; border: 1px solid #d0d7de; }
        .stat-val { font-weight: bold; font-size: 1.2em; color: #0969da; }
        canvas { margin-top: 20px; max-height: 500px; }
    </style>
</head>
<body>

<div class="container">
    <h1>GitHub Actions Performance Analysis</h1>
    
    <div class="input-area">
        <p>CSVファイルを選択するか、テキストエリアに貼り付けて「解析する」を押してください。</p>
        <input type="file" id="csvFile" accept=".csv">
        <br>
        <textarea id="csvText" placeholder="run_number,created_at,updated_at,conclusion,duration_sec..."></textarea>
        <br>
        <button onclick="processData()">解析する</button>
    </div>

    <div id="stats"></div>
    <canvas id="myChart"></canvas>
</div>

<script>
    let chartInstance = null;

    // CSVをパースしてチャートを描画するメイン関数
    function processData() {
        const fileInput = document.getElementById('csvFile');
        const textInput = document.getElementById('csvText');

        if (fileInput.files.length > 0) {
            Papa.parse(fileInput.files[0], {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    analyzeAndDraw(results.data);
                }
            });
        } else if (textInput.value.trim() !== "") {
            const results = Papa.parse(textInput.value.trim(), {
                header: true,
                skipEmptyLines: true
            });
            analyzeAndDraw(results.data);
        } else {
            alert("CSVデータを入力してください");
        }
    }

    function analyzeAndDraw(data) {
        // 1. データのクリーニングと整形
        let cleanData = data
            .filter(row => row.conclusion === 'success') // 成功のみ
            .map(row => ({
                x: new Date(row.created_at), // 日付
                y: parseFloat(row.duration_sec), // 秒数
                raw: row
            }))
            .filter(row => !isNaN(row.y) && row.x instanceof Date && !isNaN(row.x)); // 無効なデータを除外

        // 日付順にソート（古い順）
        cleanData.sort((a, b) => a.x - b.x);

        if (cleanData.length === 0) {
            alert("有効なsuccessデータが見つかりませんでした。");
            return;
        }

        // 2. 外れ値の除去 (IQR法)
        const durations = cleanData.map(d => d.y).sort((a, b) => a - b);
        const q1 = durations[Math.floor((durations.length / 4))];
        const q3 = durations[Math.floor((durations.length * (3 / 4)))];
        const iqr = q3 - q1;
        const lowerBound = q1 - (1.5 * iqr); // 下限（早すぎるのは基本OKだがエラーの可能性もあるので一応）
        const upperBound = q3 + (1.5 * iqr); // 上限（これより遅いのは除外）

        const filteredData = cleanData.filter(d => d.y >= lowerBound && d.y <= upperBound);
        const outliersCount = cleanData.length - filteredData.length;

        // 3. 移動平均の計算 (トレンドライン用)
        // 直近N回の平均を取る（データ数に応じてウィンドウサイズを調整）
        const windowSize = Math.max(5, Math.floor(filteredData.length * 0.05)); 
        const movingAverageData = filteredData.map((row, index, array) => {
            if (index < windowSize - 1) return null;
            const subset = array.slice(index - windowSize + 1, index + 1);
            const avg = subset.reduce((sum, r) => sum + r.y, 0) / windowSize;
            return { x: row.x, y: avg };
        }).filter(r => r !== null);

        // 4. 統計情報の表示
        const avgDuration = (filteredData.reduce((sum, r) => sum + r.y, 0) / filteredData.length).toFixed(1);
        // 直近10件の平均
        const recentData = filteredData.slice(-10);
        const recentAvg = (recentData.reduce((sum, r) => sum + r.y, 0) / recentData.length).toFixed(1);
        
        document.getElementById('stats').innerHTML = `
            <div class="stat-box">データ数: <div class="stat-val">${filteredData.length}</div><small>(除外された外れ値: ${outliersCount}件)</small></div>
            <div class="stat-box">全体の平均時間: <div class="stat-val">${avgDuration}秒</div></div>
            <div class="stat-box">直近10回の平均: <div class="stat-val">${recentAvg}秒</div></div>
        `;

        // 5. チャート描画
        const ctx = document.getElementById('myChart').getContext('2d');
        
        if (chartInstance) {
            chartInstance.destroy();
        }

        chartInstance = new Chart(ctx, {
            data: {
                datasets: [
                    {
                        type: 'scatter',
                        label: '実行時間 (秒)',
                        data: filteredData,
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        pointRadius: 3,
                        order: 2
                    },
                    {
                        type: 'line',
                        label: `トレンド (移動平均 ${windowSize}走)`,
                        data: movingAverageData,
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 2,
                        pointRadius: 0, // 線だけ表示
                        tension: 0.3, // 少し滑らかに
                        fill: false,
                        order: 1
                    }
                ]
            },
            options: {
                responsive: true,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'GitHub Actions Execution Time History'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y.toFixed(1) + ' sec';
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day', // データ量に応じて 'hour' や 'week' に自動調整されますが、明示したい場合変更可
                            displayFormats: {
                                day: 'MM/dd'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Created At'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Duration (seconds)'
                        }
                    }
                }
            }
        });
    }
</script>

</body>
</html>