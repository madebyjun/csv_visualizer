<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Actions 実行時間トレンド解析 (修正版)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; background-color: #f6f8fa; color: #24292f; }
        h1 { border-bottom: 1px solid #d0d7de; padding-bottom: 10px; }
        .container { background: white; padding: 20px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.12); border: 1px solid #d0d7de; }
        .input-area { margin-bottom: 20px; }
        textarea { width: 100%; height: 100px; margin-top: 10px; padding: 8px; border-radius: 6px; border: 1px solid #d0d7de; font-family: monospace; font-size: 12px; }
        button { margin-top: 10px; background-color: #2da44e; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-weight: bold; cursor: pointer; }
        button:hover { background-color: #2c974b; }
        #stats { margin-top: 20px; display: flex; gap: 20px; flex-wrap: wrap; font-size: 0.9em; color: #57606a; }
        .stat-box { background: #f6f8fa; padding: 10px; border-radius: 6px; border: 1px solid #d0d7de; flex: 1; min-width: 150px; }
        .stat-val { font-weight: bold; font-size: 1.5em; color: #0969da; }
        .stat-val.highlight { color: #2da44e; }
        canvas { margin-top: 20px; max-height: 500px; }
    </style>
</head>
<body>

<div class="container">
    <h1>GitHub Actions Speed Trends</h1>
    
    <div class="input-area">
        <p>CSVデータを貼り付けてください</p>
        <textarea id="csvText" placeholder="run_number,created_at,updated_at,conclusion,duration_sec..."></textarea>
        <br>
        <button onclick="processData()">解析・描画</button>
    </div>

    <div id="stats"></div>
    <canvas id="myChart"></canvas>
</div>

<script>
    let chartInstance = null;

    function processData() {
        const textInput = document.getElementById('csvText').value.trim();
        if (!textInput) { alert("CSVを入力してください"); return; }

        const results = Papa.parse(textInput, {
            header: true,
            skipEmptyLines: true
        });
        
        analyzeAndDraw(results.data);
    }

    function analyzeAndDraw(data) {
        // 1. クリーニング & 日付ソート
        let cleanData = data
            .filter(row => row.conclusion === 'success')
            .map(row => ({
                x: new Date(row.created_at),
                y: parseFloat(row.duration_sec),
                raw: row
            }))
            .filter(row => !isNaN(row.y) && !isNaN(row.x.getTime()));

        // 古い順(左) -> 新しい順(右) に並べ替え
        cleanData.sort((a, b) => a.x - b.x);

        if (cleanData.length === 0) {
            alert("有効なデータがありません");
            return;
        }

        // 2. 外れ値処理 (修正版: 遅すぎる値のみカットし、早すぎる値は残す)
        const durations = cleanData.map(d => d.y).sort((a, b) => a - b);
        const q1 = durations[Math.floor((durations.length / 4))];
        const q3 = durations[Math.floor((durations.length * (3 / 4)))];
        const iqr = q3 - q1;
        const upperBound = q3 + (3.0 * iqr); // 係数を1.5->3.0に緩和(本当に異常なスパイクだけ消す)

        // 下限チェック(lowerBound)を削除しました。0秒以上かつ上限以下なら採用
        const filteredData = cleanData.filter(d => d.y > 0 && d.y <= upperBound);
        const outliersCount = cleanData.length - filteredData.length;

        // 3. 統計計算
        // 直近10件（配列の最後尾）
        const recentData = filteredData.slice(-10);
        
        // 全期間平均
        const allAvg = (filteredData.reduce((sum, r) => sum + r.y, 0) / filteredData.length).toFixed(1);
        // 直近平均
        const recentAvg = (recentData.reduce((sum, r) => sum + r.y, 0) / recentData.length).toFixed(1);

        // 差分計算（高速化の成果）
        const diff = (allAvg - recentAvg).toFixed(1);
        const improvementText = diff > 0 ? `(${diff}秒 短縮)` : '';

        document.getElementById('stats').innerHTML = `
            <div class="stat-box">データ件数<div class="stat-val">${filteredData.length}</div></div>
            <div class="stat-box">全期間平均<div class="stat-val">${allAvg}s</div></div>
            <div class="stat-box">直近10回平均<div class="stat-val highlight">${recentAvg}s</div><small>${improvementText}</small></div>
        `;

        // 4. 移動平均線（トレンド）
        const windowSize = Math.max(3, Math.floor(filteredData.length * 0.1)); 
        const movingAverageData = filteredData.map((row, index, array) => {
            if (index < windowSize - 1) return null;
            const subset = array.slice(index - windowSize + 1, index + 1);
            const avg = subset.reduce((sum, r) => sum + r.y, 0) / windowSize;
            return { x: row.x, y: avg };
        }).filter(r => r !== null);

        // 5. チャート描画
        const ctx = document.getElementById('myChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            data: {
                datasets: [
                    {
                        type: 'scatter',
                        label: '実行時間',
                        data: filteredData,
                        backgroundColor: 'rgba(54, 162, 235, 0.4)',
                        pointRadius: 3
                    },
                    {
                        type: 'line',
                        label: `トレンド (移動平均)`,
                        data: movingAverageData,
                        borderColor: '#cf222e', // GitHubの赤色
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.3,
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    x: { type: 'time', time: { unit: 'day', displayFormats: { day: 'MM/dd' } } },
                    y: { beginAtZero: true, title: { display: true, text: '秒数' } }
                }
            }
        });
    }
</script>
</body>
</html>