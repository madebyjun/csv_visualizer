<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CI/CD Performance Analytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;display=swap">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            overflow: hidden;
        }

        .tooltip {
            pointer-events: none;
            transition: opacity 0.1s ease;
        }

        /* Custom Scrollbar for table */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Dark mode scrollbar */
        .dark .custom-scrollbar::-webkit-scrollbar-track {
            background: #0f172a;
        }

        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #334155;
        }

        .dark .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>

<body class="bg-slate-50 text-slate-800 h-screen flex flex-col overflow-hidden dark:bg-slate-950 dark:text-slate-200">

    <!-- Navigation Bar -->
    <nav
        class="bg-white border-b border-slate-200 h-16 flex-none px-6 flex items-center justify-between z-10 dark:bg-slate-900 dark:border-slate-800">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white">
                <span class="material-symbols-outlined text-xl">analytics</span>
            </div>
            <h1 class="text-lg font-bold text-slate-800 tracking-tight dark:text-white">Pipeline Insights</h1>
        </div>
        <div class="flex items-center gap-4">
            <button
                class="flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-slate-600 hover:bg-slate-100 rounded-md transition-colors dark:text-slate-400 dark:hover:bg-slate-800 dark:hover:text-slate-200">
                <span class="material-symbols-outlined text-[18px]">help</span>
                <span>ヘルプ</span>
            </button>
            <button id="theme-toggle"
                class="flex items-center justify-center w-8 h-8 text-slate-600 hover:bg-slate-100 rounded-md transition-colors dark:text-slate-400 dark:hover:bg-slate-800 dark:hover:text-slate-200">
                <span class="material-symbols-outlined text-[20px] dark:hidden">dark_mode</span>
                <span class="material-symbols-outlined text-[20px] hidden dark:block">light_mode</span>
            </button>
            <div
                class="h-8 w-8 rounded-full bg-slate-200 flex items-center justify-center text-slate-500 font-medium text-sm cursor-pointer dark:bg-slate-800 dark:text-slate-400">
                MJ
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="flex-1 flex overflow-hidden">

        <!-- Sidebar (Visual only) -->
        <aside
            class="w-64 bg-white border-r border-slate-200 flex-none hidden md:flex flex-col py-4 dark:bg-slate-900 dark:border-slate-800">
            <div class="px-4 mb-6">
                <button id="import-btn"
                    class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center gap-2 transition-colors shadow-sm group">
                    <span class="material-symbols-outlined group-hover:animate-bounce">upload_file</span>
                    CSVインポート
                </button>
                <input type="file" id="csv-input" accept=".csv" class="hidden">
            </div>
            <nav class="space-y-1 px-2 text-sm font-medium">
                <a href="#"
                    class="flex items-center gap-3 px-3 py-2 text-indigo-600 bg-indigo-50 rounded-md dark:bg-indigo-900/20 dark:text-indigo-400">
                    <span class="material-symbols-outlined">monitoring</span>
                    ダッシュボード
                </a>
                <a href="#"
                    class="flex items-center gap-3 px-3 py-2 text-slate-600 hover:bg-slate-50 rounded-md dark:text-slate-400 dark:hover:bg-slate-800 dark:hover:text-slate-200">
                    <span class="material-symbols-outlined">history</span>
                    実行履歴
                </a>
                <a href="#"
                    class="flex items-center gap-3 px-3 py-2 text-slate-600 hover:bg-slate-50 rounded-md dark:text-slate-400 dark:hover:bg-slate-800 dark:hover:text-slate-200">
                    <span class="material-symbols-outlined">settings</span>
                    設定
                </a>
            </nav>

            <div class="mt-auto px-4 pb-4">
                <div class="bg-slate-50 p-3 rounded-lg border border-slate-200 dark:bg-slate-800 dark:border-slate-700">
                    <p class="text-xs font-semibold text-slate-500 uppercase mb-2 dark:text-slate-400">データソース</p>
                    <div class="flex items-center gap-2 text-sm text-slate-700 truncate dark:text-slate-300">
                        <span class="material-symbols-outlined text-slate-400 text-base">description</span>
                        <span class="truncate" id="filename-display">No File Selected</span>
                    </div>
                    <div class="mt-2 text-xs text-slate-400 flex items-center gap-1">
                        <span class="w-2 h-2 rounded-full bg-slate-300" id="status-dot"></span>
                        <span id="status-text">待機中</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Dashboard Area -->
        <main class="flex-1 overflow-y-auto custom-scrollbar p-6 lg:p-8">

            <!-- Header Section -->
            <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-8">
                <div>
                    <h2 class="text-2xl font-bold text-slate-900 dark:text-white" id="project-title">Project Analytics
                    </h2>
                    <p class="text-sm text-slate-500 mt-1 dark:text-slate-400">実行パフォーマンスと傾向分析</p>
                </div>
                <div
                    class="flex items-center bg-white rounded-lg shadow-sm border border-slate-200 p-1 dark:bg-slate-900 dark:border-slate-800">
                    <button data-range="24h"
                        class="time-range-btn px-3 py-1 text-sm font-medium text-indigo-600 bg-indigo-50 rounded shadow-sm transition-colors dark:bg-indigo-900/20 dark:text-indigo-400">24時間</button>
                    <button data-range="7d"
                        class="time-range-btn px-3 py-1 text-sm font-medium text-slate-600 hover:text-slate-900 rounded hover:bg-slate-50 transition-colors dark:text-slate-400 dark:hover:text-slate-200 dark:hover:bg-slate-800">7日間</button>
                    <button data-range="30d"
                        class="time-range-btn px-3 py-1 text-sm font-medium text-slate-600 hover:text-slate-900 rounded hover:bg-slate-50 transition-colors dark:text-slate-400 dark:hover:text-slate-200 dark:hover:bg-slate-800">30日間</button>
                    <button data-range="all"
                        class="time-range-btn px-3 py-1 text-sm font-medium text-slate-600 hover:text-slate-900 rounded hover:bg-slate-50 transition-colors dark:text-slate-400 dark:hover:text-slate-200 dark:hover:bg-slate-800">全期間</button>
                </div>
            </div>

            <!-- KPI Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Card 1 -->
                <div
                    class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 relative overflow-hidden group dark:bg-slate-900 dark:border-slate-800">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-xs font-medium text-slate-500 uppercase tracking-wider dark:text-slate-400">
                                平均実行時間</p>
                            <h3 class="text-2xl font-bold text-slate-900 mt-1 dark:text-white" id="kpi-avg-duration">-
                            </h3>
                        </div>
                        <div class="p-2 bg-blue-50 rounded-lg text-blue-600 dark:bg-blue-900/20 dark:text-blue-400">
                            <span class="material-symbols-outlined">timer</span>
                        </div>
                    </div>
                    <div class="flex items-center text-xs font-medium text-slate-500 dark:text-slate-400"
                        id="kpi-avg-trend">
                        <span>-</span>
                    </div>
                </div>

                <!-- Card 2 -->
                <div
                    class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 relative overflow-hidden dark:bg-slate-900 dark:border-slate-800">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-xs font-medium text-slate-500 uppercase tracking-wider dark:text-slate-400">
                                成功率</p>
                            <h3 class="text-2xl font-bold text-slate-900 mt-1 dark:text-white" id="kpi-success-rate">-
                            </h3>
                        </div>
                        <div
                            class="p-2 bg-emerald-50 rounded-lg text-emerald-600 dark:bg-emerald-900/20 dark:text-emerald-400">
                            <span class="material-symbols-outlined">check_circle</span>
                        </div>
                    </div>
                    <div class="flex items-center text-xs font-medium text-slate-500 dark:text-slate-400">
                        <span id="kpi-success-count">-</span>
                    </div>
                </div>

                <!-- Card 3 -->
                <div
                    class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 relative overflow-hidden dark:bg-slate-900 dark:border-slate-800">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-xs font-medium text-slate-500 uppercase tracking-wider dark:text-slate-400">
                                合計実行回数</p>
                            <h3 class="text-2xl font-bold text-slate-900 mt-1 dark:text-white" id="kpi-total-runs">-
                            </h3>
                        </div>
                        <div
                            class="p-2 bg-violet-50 rounded-lg text-violet-600 dark:bg-violet-900/20 dark:text-violet-400">
                            <span class="material-symbols-outlined">repeat</span>
                        </div>
                    </div>
                    <div class="flex items-center text-xs font-medium text-slate-500 dark:text-slate-400">
                        <span id="kpi-frequency">-</span>
                    </div>
                </div>

                <!-- Card 4 -->
                <div
                    class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 relative overflow-hidden dark:bg-slate-900 dark:border-slate-800">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-xs font-medium text-slate-500 uppercase tracking-wider dark:text-slate-400">
                                最新ステータス</p>
                            <h3 class="text-xl font-bold mt-1 text-slate-400 dark:text-slate-500"
                                id="kpi-latest-status">-</h3>
                        </div>
                        <div
                            class="p-2 bg-orange-50 rounded-lg text-orange-600 dark:bg-orange-900/20 dark:text-orange-400">
                            <span class="material-symbols-outlined">update</span>
                        </div>
                    </div>
                    <div class="text-xs text-slate-400 dark:text-slate-500" id="kpi-latest-time">-</div>
                </div>
            </div>

            <!-- Main Chart Section -->
            <div
                class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-8 dark:bg-slate-900 dark:border-slate-800">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-bold text-slate-800 dark:text-white">実行時間の推移 (Duration Trend)</h3>
                    <div class="flex items-center gap-2">
                        <span class="flex items-center gap-1 text-xs text-slate-500 dark:text-slate-400"><span
                                class="w-2 h-2 rounded-full bg-emerald-500"></span>Success</span>
                        <span class="flex items-center gap-1 text-xs text-slate-500 dark:text-slate-400"><span
                                class="w-2 h-2 rounded-full bg-rose-500"></span>Failure</span>
                    </div>
                </div>

                <!-- Interactive SVG Chart -->
                <div class="chart-container group" id="trend-chart">
                    <!-- Tooltip Element (Hidden by default) -->
                    <div id="chart-tooltip"
                        class="tooltip absolute opacity-0 bg-slate-800 text-white text-xs rounded py-1 px-2 z-20 shadow-lg transform -translate-x-1/2 -translate-y-full mt-[-8px] pointer-events-none whitespace-nowrap">
                        <p class="font-bold"><span id="tt-run"></span></p>
                        <p>Duration: <span id="tt-dur" class="font-mono text-blue-300"></span></p>
                        <p>Status: <span id="tt-status"></span></p>
                    </div>
                    <svg width="100%" height="100%" class="overflow-visible" id="chart-svg">
                        <!-- SVG Content will be injected here -->
                    </svg>
                    <div id="chart-empty-state"
                        class="absolute inset-0 flex items-center justify-center text-slate-400 text-sm dark:text-slate-600">
                        データがありません
                    </div>
                </div>
            </div>

            <!-- Data Table Section -->
            <div
                class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden dark:bg-slate-900 dark:border-slate-800">
                <div
                    class="px-6 py-4 border-b border-slate-100 flex items-center justify-between bg-slate-50/50 dark:bg-slate-800/50 dark:border-slate-800">
                    <h3 class="text-sm font-bold text-slate-700 uppercase tracking-wide dark:text-slate-300">詳細ログ</h3>
                    <button
                        class="text-xs text-indigo-600 font-medium hover:underline flex items-center gap-1 dark:text-indigo-400">
                        全データをダウンロード
                        <span class="material-symbols-outlined text-sm">download</span>
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead
                            class="text-xs text-slate-500 uppercase bg-slate-50 border-b border-slate-200 dark:bg-slate-800 dark:border-slate-700 dark:text-slate-400">
                            <tr>
                                <th class="px-6 py-3 font-medium">Run #</th>
                                <th class="px-6 py-3 font-medium">Status</th>
                                <th class="px-6 py-3 font-medium">Duration (sec)</th>
                                <th class="px-6 py-3 font-medium">Started At</th>
                                <th class="px-6 py-3 font-medium text-right">Action</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100 dark:divide-slate-800" id="table-body">
                            <!-- Table rows will be injected here -->
                        </tbody>
                    </table>
                    <div id="table-empty-state"
                        class="p-8 text-center text-slate-400 text-sm hidden dark:text-slate-600">
                        表示するデータがありません
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        // Global State
        let rawData = [];
        let filteredData = [];
        let currentRange = '24h';

        const App = {
            init() {
                this.setupTheme();
                this.setupEventListeners();
                this.renderEmptyState();
            },

            setupTheme() {
                const themeToggleBtn = document.getElementById('theme-toggle');
                const html = document.documentElement;

                // Check local storage or system preference
                if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    html.classList.add('dark');
                } else {
                    html.classList.remove('dark');
                }

                themeToggleBtn.addEventListener('click', () => {
                    html.classList.toggle('dark');
                    if (html.classList.contains('dark')) {
                        localStorage.theme = 'dark';
                    } else {
                        localStorage.theme = 'light';
                    }
                    // Re-render chart to update colors
                    this.renderChart();
                });
            },

            setupEventListeners() {
                // CSV Import Button
                document.getElementById('import-btn').addEventListener('click', () => {
                    document.getElementById('csv-input').click();
                });

                // File Input Change
                document.getElementById('csv-input').addEventListener('change', (e) => {
                    this.handleFileUpload(e.target.files[0]);
                });

                // Time Range Buttons
                document.querySelectorAll('.time-range-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        // Update active class
                        document.querySelectorAll('.time-range-btn').forEach(b => {
                            b.classList.remove('bg-indigo-50', 'text-indigo-600', 'shadow-sm');
                            b.classList.add('text-slate-600', 'hover:bg-slate-50', 'hover:text-slate-900');
                        });
                        e.target.classList.remove('text-slate-600', 'hover:bg-slate-50', 'hover:text-slate-900');
                        e.target.classList.add('bg-indigo-50', 'text-indigo-600', 'shadow-sm');

                        currentRange = e.target.dataset.range;
                        this.filterData(currentRange);
                    });
                });
            },

            handleFileUpload(file) {
                if (!file) return;

                // Update UI
                document.getElementById('filename-display').textContent = file.name;
                document.getElementById('status-dot').className = "w-2 h-2 rounded-full bg-emerald-500 animate-pulse";
                document.getElementById('status-text').textContent = "解析中...";

                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        this.processData(results.data);
                        document.getElementById('status-dot').className = "w-2 h-2 rounded-full bg-emerald-500";
                        document.getElementById('status-text').textContent = "完了";
                        document.getElementById('project-title').textContent = file.name.replace('.csv', '');
                    },
                    error: (err) => {
                        console.error(err);
                        alert("CSVの読み込みに失敗しました");
                        document.getElementById('status-dot').className = "w-2 h-2 rounded-full bg-rose-500";
                        document.getElementById('status-text').textContent = "エラー";
                    }
                });
            },

            processData(data) {
                // Transform and sort
                rawData = data.map(row => ({
                    run_number: parseInt(row.run_number),
                    created_at: row.created_at,
                    timestamp: new Date(row.created_at).getTime(),
                    conclusion: row.conclusion,
                    duration_sec: parseFloat(row.duration_sec),
                    html_url: row.html_url || '#'
                }))
                    .filter(d => !isNaN(d.duration_sec) && !isNaN(d.timestamp))
                    .sort((a, b) => b.timestamp - a.timestamp); // Newest first

                if (rawData.length === 0) {
                    alert("有効なデータが見つかりませんでした");
                    return;
                }

                this.filterData(currentRange);
            },

            filterData(range) {
                if (rawData.length === 0) return;

                // Filter relative to the LATEST data point, not "now", to support old CSVs
                const latestTime = rawData[0].timestamp;
                let startTime;

                if (range === '24h') startTime = latestTime - 24 * 60 * 60 * 1000;
                else if (range === '7d') startTime = latestTime - 7 * 24 * 60 * 60 * 1000;
                else if (range === '30d') startTime = latestTime - 30 * 24 * 60 * 60 * 1000;
                else startTime = 0; // All time

                filteredData = rawData.filter(d => d.timestamp >= startTime);

                // Sort for chart (Oldest -> Newest)
                // But rawData is Newest -> Oldest.
                // We'll handle sorting in render functions as needed.

                this.renderAll();
            },

            renderAll() {
                document.getElementById('chart-empty-state').classList.add('hidden');
                document.getElementById('table-empty-state').classList.add('hidden');

                this.renderKPIs();
                this.renderChart();
                this.renderTable();
            },

            renderEmptyState() {
                document.getElementById('kpi-avg-duration').textContent = '-';
                document.getElementById('kpi-success-rate').textContent = '-';
                document.getElementById('kpi-total-runs').textContent = '-';
                document.getElementById('kpi-latest-status').textContent = '-';
                document.getElementById('chart-empty-state').classList.remove('hidden');
                document.getElementById('table-empty-state').classList.remove('hidden');
            },

            formatDate(dateStr) {
                const d = new Date(dateStr);
                return d.toLocaleString('ja-JP', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            },

            renderKPIs() {
                if (filteredData.length === 0) {
                    this.renderEmptyState();
                    return;
                }

                const totalRuns = filteredData.length;
                const successRuns = filteredData.filter(d => d.conclusion === 'success').length;
                const successRate = ((successRuns / totalRuns) * 100).toFixed(1);
                const avgDuration = (filteredData.reduce((acc, curr) => acc + curr.duration_sec, 0) / totalRuns).toFixed(1);
                const latest = filteredData[0]; // filteredData is subset of rawData (Newest first)

                document.getElementById('kpi-avg-duration').textContent = `${avgDuration}s`;
                document.getElementById('kpi-success-rate').textContent = `${successRate}%`;
                document.getElementById('kpi-total-runs').textContent = totalRuns;
                document.getElementById('kpi-success-count').textContent = `成功: ${successRuns} / 失敗: ${totalRuns - successRuns}`;
                document.getElementById('kpi-frequency').textContent = `期間: ${currentRange}`;

                const latestEl = document.getElementById('kpi-latest-status');
                latestEl.textContent = latest.conclusion === 'success' ? '成功' : '失敗';
                latestEl.className = `text-xl font-bold mt-1 ${latest.conclusion === 'success' ? 'text-emerald-600' : 'text-rose-600'}`;

                document.getElementById('kpi-latest-time').textContent = this.formatDate(latest.created_at);
            },

            renderChart() {
                const svg = document.getElementById('chart-svg');
                const container = document.getElementById('trend-chart');
                const tooltip = document.getElementById('chart-tooltip');

                svg.innerHTML = '';

                if (filteredData.length === 0) return;

                const width = container.clientWidth;
                const height = container.clientHeight;
                const padding = { top: 20, right: 20, bottom: 30, left: 40 };

                // Chart needs Oldest -> Newest
                const chartData = [...filteredData].reverse();

                const maxDur = Math.max(...chartData.map(d => d.duration_sec)) * 1.2;

                const xScale = (index) => padding.left + (index / (chartData.length - 1 || 1)) * (width - padding.left - padding.right);
                const yScale = (val) => height - padding.bottom - (val / maxDur) * (height - padding.top - padding.bottom);

                const isDark = document.documentElement.classList.contains('dark');
                const gridColor = isDark ? '#1e293b' : '#f1f5f9'; // slate-800 : slate-100
                const textColor = isDark ? '#64748b' : '#94a3b8'; // slate-500 : slate-400

                // 1. Grid Lines
                const gridCount = 5;
                for (let i = 0; i <= gridCount; i++) {
                    const val = (maxDur / gridCount) * i;
                    const y = yScale(val);

                    const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                    line.setAttribute("x1", padding.left);
                    line.setAttribute("y1", y);
                    line.setAttribute("x2", width - padding.right);
                    line.setAttribute("y2", y);
                    line.setAttribute("stroke", gridColor);
                    line.setAttribute("stroke-width", "1");
                    svg.appendChild(line);

                    const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                    text.setAttribute("x", padding.left - 10);
                    text.setAttribute("y", y + 4);
                    text.setAttribute("text-anchor", "end");
                    text.setAttribute("fill", textColor);
                    text.setAttribute("font-size", "10");
                    text.textContent = Math.round(val) + 's';
                    svg.appendChild(text);
                }

                // 2. Trend Line
                if (chartData.length > 1) {
                    const points = chartData.map((d, i) => `${xScale(i)},${yScale(d.duration_sec)}`).join(" ");
                    const polyline = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
                    polyline.setAttribute("points", points);
                    polyline.setAttribute("fill", "none");
                    polyline.setAttribute("stroke", "#6366f1");
                    polyline.setAttribute("stroke-width", "2");
                    polyline.setAttribute("stroke-linejoin", "round");
                    polyline.setAttribute("stroke-linecap", "round");
                    polyline.innerHTML = `<animate attributeName="stroke-dasharray" from="0, 10000" to="10000, 0" duration="1.5s" />`;
                    svg.appendChild(polyline);

                    // Area
                    const areaPathStr = `${padding.left},${height - padding.bottom} ` + points + ` ${width - padding.right},${height - padding.bottom}`;
                    const area = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
                    area.setAttribute("points", areaPathStr);
                    area.setAttribute("fill", "rgba(99, 102, 241, 0.1)");
                    svg.appendChild(area);
                }

                // 3. Data Points
                chartData.forEach((d, i) => {
                    const x = xScale(i);
                    const y = yScale(d.duration_sec);
                    const color = d.conclusion === 'success' ? '#10b981' : '#f43f5e';

                    const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                    circle.setAttribute("cx", x);
                    circle.setAttribute("cy", y);
                    circle.setAttribute("r", "4");
                    circle.setAttribute("fill", "white");
                    circle.setAttribute("stroke", color);
                    circle.setAttribute("stroke-width", "2");
                    circle.classList.add("transition-all", "duration-200", "ease-in-out");
                    svg.appendChild(circle);

                    // Hit Area
                    const hitArea = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    hitArea.setAttribute("x", x - 10);
                    hitArea.setAttribute("y", 0);
                    hitArea.setAttribute("width", 20);
                    hitArea.setAttribute("height", height);
                    hitArea.setAttribute("fill", "transparent");
                    hitArea.style.cursor = "pointer";

                    hitArea.addEventListener('mouseenter', () => {
                        circle.setAttribute("r", "6");
                        circle.setAttribute("fill", color);

                        tooltip.style.opacity = "1";
                        tooltip.style.left = `${x}px`;
                        tooltip.style.top = `${y}px`;

                        document.getElementById('tt-run').textContent = `Run #${d.run_number}`;
                        document.getElementById('tt-dur').textContent = `${d.duration_sec}s`;
                        document.getElementById('tt-status').textContent = d.conclusion;
                        document.getElementById('tt-status').className = d.conclusion === 'success' ? 'text-emerald-300' : 'text-rose-300 font-bold';
                    });

                    hitArea.addEventListener('mouseleave', () => {
                        circle.setAttribute("r", "4");
                        circle.setAttribute("fill", "white");
                        tooltip.style.opacity = "0";
                    });

                    svg.appendChild(hitArea);
                });
            },

            renderTable() {
                const tbody = document.getElementById('table-body');
                tbody.innerHTML = '';

                if (filteredData.length === 0) {
                    document.getElementById('table-empty-state').classList.remove('hidden');
                    return;
                }

                // Table shows Newest -> Oldest (filteredData is already sorted this way)
                // Limit to 50 rows for performance
                const tableData = filteredData.slice(0, 50);

                tableData.forEach(d => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-slate-50 transition-colors group dark:hover:bg-slate-800/50";

                    const statusColor = d.conclusion === 'success'
                        ? 'bg-emerald-100 text-emerald-700 border-emerald-200 dark:bg-emerald-900/20 dark:text-emerald-400 dark:border-emerald-900/30'
                        : 'bg-rose-100 text-rose-700 border-rose-200 dark:bg-rose-900/20 dark:text-rose-400 dark:border-rose-900/30';

                    const icon = d.conclusion === 'success' ? 'check' : 'close';

                    // Calculate bar width relative to max duration in this set
                    const maxDur = Math.max(...tableData.map(x => x.duration_sec)) || 1;
                    const barWidth = (d.duration_sec / maxDur) * 100;

                    tr.innerHTML = `
                        <td class="px-6 py-4 font-mono text-slate-600 dark:text-slate-400">#${d.run_number}</td>
                        <td class="px-6 py-4">
                            <span class="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-medium border ${statusColor}">
                                <span class="material-symbols-outlined text-[14px] font-bold">${icon}</span>
                                ${d.conclusion}
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-2">
                                <span class="font-medium text-slate-700 dark:text-slate-300">${d.duration_sec}s</span>
                                <div class="w-16 h-1.5 bg-slate-100 rounded-full overflow-hidden dark:bg-slate-800">
                                    <div class="h-full ${d.conclusion === 'success' ? 'bg-indigo-500' : 'bg-rose-500'}" style="width: ${barWidth}%"></div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-slate-500 dark:text-slate-400">${this.formatDate(d.created_at)}</td>
                        <td class="px-6 py-4 text-right">
                            <a href="${d.html_url}" target="_blank" class="text-slate-400 hover:text-indigo-600 transition-colors p-1 rounded hover:bg-indigo-50 inline-block dark:text-slate-500 dark:hover:text-indigo-400 dark:hover:bg-indigo-900/20">
                                <span class="material-symbols-outlined">open_in_new</span>
                            </a>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        };

        // Start the app
        document.addEventListener('DOMContentLoaded', () => {
            App.init();
        });

    </script>

</body>

</html>